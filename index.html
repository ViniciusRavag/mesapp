<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pedidos - Restaurante</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .stat-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        /* Mesas Grid */
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .table-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .table-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .table-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .table-card.occupied {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .table-card.waiting-order {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .table-card.waiting-payment {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
            color: white;
        }

        .table-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .table-status {
            font-size: 12px;
            opacity: 0.9;
        }

        .table-total {
            margin-top: 10px;
            font-size: 16px;
            font-weight: 600;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 20px 20px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 {
            margin-bottom: 5px;
        }

        .modal-body {
            padding: 25px;
        }

        /* Menu Categories */
        .menu-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .category-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Menu Items */
        .menu-items {
            display: grid;
            gap: 15px;
        }

        .menu-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .menu-item-info h3 {
            margin-bottom: 5px;
            color: #333;
        }

        .menu-item-price {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .menu-item-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            border-radius: 25px;
            padding: 5px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .quantity-btn:hover {
            transform: scale(1.1);
        }

        .quantity-display {
            width: 40px;
            text-align: center;
            font-weight: bold;
        }

        /* Order Summary */
        .order-summary {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-total {
            font-size: 24px;
            font-weight: bold;
            margin-top: 15px;
            text-align: right;
            color: #667eea;
        }

        .observation-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin-top: 10px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        /* Kitchen View */
        .kitchen-orders {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .order-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.5s ease;
        }

        .order-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-card-header.preparing {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .order-card-header.ready {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }

        .order-time {
            font-size: 12px;
            opacity: 0.9;
        }

        .order-card-body {
            padding: 20px;
        }

        .order-item-kitchen {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-item-kitchen:hover {
            background: #e9ecef;
        }

        .order-item-kitchen.completed {
            background: #d4edda;
            text-decoration: line-through;
            opacity: 0.6;
        }

        .item-observation {
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
            margin-top: 5px;
        }

        .order-actions {
            padding: 0 20px 20px;
            display: flex;
            gap: 10px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-30px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tables-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .kitchen-orders {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 10px;
            }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid #56ab2f;
        }

        .toast.error {
            border-left: 4px solid #eb3349;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cashier View -->
        <div id="cashierView" style="display: none;">
            <div class="header">
                <h1>🍽️ Sistema de Pedidos</h1>
                <div class="header-info">
                    <span class="stat-badge">Mesas Ocupadas: <span id="occupiedCount">0</span></span>
                    <span class="stat-badge">Pedidos Pendentes: <span id="pendingCount">0</span></span>
                </div>
            </div>

            <div class="tables-grid" id="tablesGrid"></div>
        </div>

        <!-- Kitchen View -->
        <div id="kitchenView" style="display: none;">
            <div class="header">
                <h1>👨‍🍳 Cozinha - Pedidos</h1>
                <div class="header-info">
                    <span class="stat-badge">Pedidos Ativos: <span id="activeOrdersCount">0</span></span>
                </div>
            </div>

            <div class="kitchen-orders" id="kitchenOrders"></div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Mesa <span id="modalTableNumber"></span></h2>
                <div id="modalTableStatus"></div>
            </div>
            <div class="modal-body">
                <div class="menu-categories">
                    <button class="category-btn active" data-category="all">Todos</button>
                    <button class="category-btn" data-category="entradas">Entradas</button>
                    <button class="category-btn" data-category="pratos">Pratos Principais</button>
                    <button class="category-btn" data-category="bebidas">Bebidas</button>
                    <button class="category-btn" data-category="sobremesas">Sobremesas</button>
                </div>

                <div class="menu-items" id="menuItems"></div>

                <div class="order-summary">
                    <h3>Resumo do Pedido</h3>
                    <div id="orderItems"></div>
                    <textarea class="observation-input" placeholder="Observações do pedido..." id="orderObservation"></textarea>
                    <div class="order-total">Total: R$ <span id="orderTotal">0.00</span></div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-danger" onclick="closeModal()">Cancelar</button>
                    <button class="btn btn-success" onclick="finishOrder()">Enviar Pedido</button>
                    <button class="btn btn-primary" onclick="requestPayment()">Solicitar Pagamento</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration - ADICIONE SUAS CREDENCIAIS AQUI
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        } catch (error) {
            console.log('Firebase não configurado. Usando modo local.');
        }

        // Application State
        let currentView = 'cashier';
        let currentTable = null;
        let currentOrder = {};
        let tables = {};
        let orders = {};
        let menuData = {
            entradas: [
                { id: 1, name: 'Pão de Alho', price: 12.00 },
                { id: 2, name: 'Bruschetta', price: 18.00 },
                { id: 3, name: 'Caponata', price: 15.00 },
                { id: 4, name: 'Carpaccio', price: 28.00 }
            ],
            pratos: [
                { id: 5, name: 'Filé à Parmegiana', price: 65.00 },
                { id: 6, name: 'Salmão Grelhado', price: 72.00 },
                { id: 7, name: 'Risoto de Camarão', price: 68.00 },
                { id: 8, name: 'Lasanha Bolonhesa', price: 45.00 },
                { id: 9, name: 'Frango à Milanesa', price: 42.00 },
                { id: 10, name: 'Picanha Grelhada', price: 89.00 }
            ],
            bebidas: [
                { id: 11, name: 'Refrigerante Lata', price: 6.00 },
                { id: 12, name: 'Suco Natural', price: 10.00 },
                { id: 13, name: 'Água Mineral', price: 4.00 },
                { id: 14, name: 'Cerveja Long Neck', price: 12.00 },
                { id: 15, name: 'Taça de Vinho', price: 25.00 }
            ],
            sobremesas: [
                { id: 16, name: 'Petit Gateau', price: 22.00 },
                { id: 17, name: 'Tiramisù', price: 18.00 },
                { id: 18, name: 'Pudim', price: 12.00 },
                { id: 19, name: 'Brownie com Sorvete', price: 20.00 }
            ]
        };

        // Initialize Application
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            currentView = urlParams.get('view') || 'cashier';

            if (currentView === 'cashier') {
                document.getElementById('cashierView').style.display = 'block';
                initCashierView();
            } else if (currentView === 'kitchen') {
                document.getElementById('kitchenView').style.display = 'block';
                initKitchenView();
            }

            // Setup Firebase listeners if configured
            if (db) {
                setupFirebaseListeners();
            } else {
                // Use local storage fallback
                loadLocalData();
            }
        }

        // Initialize Cashier View
        function initCashierView() {
            // Initialize 12 tables
            for (let i = 1; i <= 12; i++) {
                tables[i] = {
                    number: i,
                    status: 'empty',
                    orders: [],
                    total: 0
                };
            }
            renderTables();
        }

        // Initialize Kitchen View
        function initKitchenView() {
            renderKitchenOrders();
        }

        // Setup Firebase Listeners
        function setupFirebaseListeners() {
            // Listen for table updates
            db.ref('tables').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    tables = data;
                    if (currentView === 'cashier') {
                        renderTables();
                    }
                }
            });

            // Listen for order updates
            db.ref('orders').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    orders = data;
                    if (currentView === 'kitchen') {
                        renderKitchenOrders();
                    }
                    updateStats();
                }
            });
        }

        // Load Local Data (Fallback)
        function loadLocalData() {
            const savedTables = localStorage.getItem('tables');
            const savedOrders = localStorage.getItem('orders');
            
            if (savedTables) {
                tables = JSON.parse(savedTables);
            }
            if (savedOrders) {
                orders = JSON.parse(savedOrders);
            }
        }

        // Save Local Data (Fallback)
        function saveLocalData() {
            localStorage.setItem('tables', JSON.stringify(tables));
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        // Render Tables
        function renderTables() {
            const grid = document.getElementById('tablesGrid');
            grid.innerHTML = '';

            Object.values(tables).forEach(table => {
                const tableCard = document.createElement('div');
                tableCard.className = `table-card ${getTableClass(table.status)}`;
                tableCard.onclick = () => openTable(table.number);
                
                tableCard.innerHTML = `
                    <div class="table-number">Mesa ${table.number}</div>
                    <div class="table-status">${getTableStatusText(table.status)}</div>
                    ${table.total > 0 ? `<div class="table-total">R$ ${table.total.toFixed(2)}</div>` : ''}
                `;
                
                grid.appendChild(tableCard);
            });

            updateStats();
        }

        // Get Table Class
        function getTableClass(status) {
            switch(status) {
                case 'occupied': return 'occupied';
                case 'waiting-order': return 'waiting-order';
                case 'waiting-payment': return 'waiting-payment';
                default: return '';
            }
        }

        // Get Table Status Text
        function getTableStatusText(status) {
            switch(status) {
                case 'empty': return 'Vazia';
                case 'occupied': return 'Ocupada';
                case 'waiting-order': return 'Aguardando Pedido';
                case 'waiting-payment': return 'Aguardando Pagamento';
                default: return '';
            }
        }

        // Open Table Modal
        function openTable(tableNumber) {
            currentTable = tableNumber;
            currentOrder = {};
            
            const modal = document.getElementById('orderModal');
            document.getElementById('modalTableNumber').textContent = tableNumber;
            document.getElementById('modalTableStatus').textContent = getTableStatusText(tables[tableNumber].status);
            
            renderMenuItems('all');
            updateOrderSummary();
            
            modal.classList.add('active');
        }

        // Close Modal
        function closeModal() {
            document.getElementById('orderModal').classList.remove('active');
            currentTable = null;
            currentOrder = {};
        }

        // Render Menu Items
        function renderMenuItems(category) {
            const container = document.getElementById('menuItems');
            container.innerHTML = '';

            let items = [];
            if (category === 'all') {
                Object.values(menuData).forEach(cat => {
                    items = items.concat(cat);
                });
            } else {
                items = menuData[category] || [];
            }

            items.forEach(item => {
                const quantity = currentOrder[item.id] ? currentOrder[item.id].quantity : 0;
                
                const itemEl = document.createElement('div');
                itemEl.className = 'menu-item';
                itemEl.innerHTML = `
                    <div class="menu-item-info">
                        <h3>${item.name}</h3>
                        <div class="menu-item-price">R$ ${item.price.toFixed(2)}</div>
                    </div>
                    <div class="menu-item-controls">
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                            <span class="quantity-display">${quantity}</span>
                            <button class="quantity-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                        </div>
                    </div>
                `;
                container.appendChild(itemEl);
            });
        }

        // Update Item Quantity
        function updateQuantity(itemId, change) {
            let item = null;
            Object.values(menuData).forEach(category => {
                const found = category.find(i => i.id === itemId);
                if (found) item = found;
            });

            if (!item) return;

            if (!currentOrder[itemId]) {
                currentOrder[itemId] = { ...item, quantity: 0 };
            }

            currentOrder[itemId].quantity += change;
            
            if (currentOrder[itemId].quantity <= 0) {
                delete currentOrder[itemId];
            }

            renderMenuItems(document.querySelector('.category-btn.active').dataset.category);
            updateOrderSummary();
        }

        // Update Order Summary
        function updateOrderSummary() {
            const container = document.getElementById('orderItems');
            const totalEl = document.getElementById('orderTotal');
            container.innerHTML = '';

            let total = 0;

            Object.values(currentOrder).forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;

                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                orderItem.innerHTML = `
                    <span>${item.quantity}x ${item.name}</span>
                    <span>R$ ${itemTotal.toFixed(2)}</span>
                `;
                container.appendChild(orderItem);
            });

            totalEl.textContent = total.toFixed(2);
        }

        // Finish Order
        function finishOrder() {
            if (Object.keys(currentOrder).length === 0) {
                showToast('Adicione itens ao pedido!', 'error');
                return;
            }

            const orderId = Date.now();
            const observation = document.getElementById('orderObservation').value;
            
            const order = {
                id: orderId,
                tableNumber: currentTable,
                items: Object.values(currentOrder),
                observation: observation,
                status: 'pending',
                timestamp: new Date().toISOString(),
                total: calculateOrderTotal()
            };

            // Save order
            orders[orderId] = order;
            
            // Update table
            tables[currentTable].status = 'occupied';
            tables[currentTable].orders.push(orderId);
            tables[currentTable].total += order.total;

            // Save to Firebase or Local Storage
            if (db) {
                db.ref(`orders/${orderId}`).set(order);
                db.ref(`tables/${currentTable}`).set(tables[currentTable]);
            } else {
                saveLocalData();
            }

            showToast('Pedido enviado para a cozinha!', 'success');
            closeModal();
            renderTables();
        }

        // Request Payment
        function requestPayment() {
            if (tables[currentTable].total === 0) {
                showToast('Não há pedidos para pagamento!', 'error');
                return;
            }

            tables[currentTable].status = 'waiting-payment';
            
            if (db) {
                db.ref(`tables/${currentTable}`).set(tables[currentTable]);
            } else {
                saveLocalData();
            }

            showToast('Pagamento solicitado!', 'success');
            closeModal();
            renderTables();
        }

        // Calculate Order Total
        function calculateOrderTotal() {
            let total = 0;
            Object.values(currentOrder).forEach(item => {
                total += item.price * item.quantity;
            });
            return total;
        }

        // Render Kitchen Orders
        function renderKitchenOrders() {
            const container = document.getElementById('kitchenOrders');
            container.innerHTML = '';

            Object.values(orders).forEach(order => {
                if (order.status === 'completed') return;

                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                
                const headerClass = order.status === 'preparing' ? 'preparing' : 
                                   order.status === 'ready' ? 'ready' : '';
                
                orderCard.innerHTML = `
                    <div class="order-card-header ${headerClass}">
                        <div>
                            <h3>Mesa ${order.tableNumber}</h3>
                            <div class="order-time">${formatTime(order.timestamp)}</div>
                        </div>
                        <span>${getOrderStatusText(order.status)}</span>
</div>
                    <div class="order-card-body">
                        ${order.items.map(item => `
                            <div class="order-item-kitchen" onclick="toggleItemStatus(${order.id}, ${item.id})">
                                <div>
                                    <strong>${item.quantity}x ${item.name}</strong>
                                    ${item.observation ? `<div class="item-observation">${item.observation}</div>` : ''}
                                </div>
                                <span>R$ ${(item.price * item.quantity).toFixed(2)}</span>
                            </div>
                        `).join('')}
                        ${order.observation ? `<div class="item-observation"><strong>Obs:</strong> ${order.observation}</div>` : ''}
                    </div>
                    <div class="order-actions">
                        ${order.status === 'pending' ? 
                            `<button class="btn btn-primary" onclick="startPreparing(${order.id})">Iniciar Preparo</button>` :
                            order.status === 'preparing' ? 
                            `<button class="btn btn-success" onclick="markOrderReady(${order.id})">Marcar como Pronto</button>` :
                            `<button class="btn btn-success" onclick="completeOrder(${order.id})">Pedido Entregue</button>`
                        }
                    </div>
                `;
                
                container.appendChild(orderCard);
            });

            updateKitchenStats();
        }

        // Get Order Status Text
        function getOrderStatusText(status) {
            switch(status) {
                case 'pending': return 'Novo Pedido';
                case 'preparing': return 'Preparando';
                case 'ready': return 'Pronto';
                case 'completed': return 'Entregue';
                default: return '';
            }
        }

        // Format Time
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        // Start Preparing Order
        function startPreparing(orderId) {
            orders[orderId].status = 'preparing';
            
            if (db) {
                db.ref(`orders/${orderId}/status`).set('preparing');
            } else {
                saveLocalData();
            }

            showToast('Pedido em preparo!', 'success');
            renderKitchenOrders();
        }

        // Mark Order Ready
        function markOrderReady(orderId) {
            orders[orderId].status = 'ready';
            
            if (db) {
                db.ref(`orders/${orderId}/status`).set('ready');
            } else {
                saveLocalData();
            }

            showToast('Pedido pronto para entrega!', 'success');
            renderKitchenOrders();
        }

        // Complete Order
        function completeOrder(orderId) {
            const order = orders[orderId];
            order.status = 'completed';
            
            // Update table status
            const tableNumber = order.tableNumber;
            tables[tableNumber].orders = tables[tableNumber].orders.filter(id => id !== orderId);
            
            if (tables[tableNumber].orders.length === 0) {
                tables[tableNumber].status = 'empty';
                tables[tableNumber].total = 0;
            }

            if (db) {
                db.ref(`orders/${orderId}/status`).set('completed');
                db.ref(`tables/${tableNumber}`).set(tables[tableNumber]);
            } else {
                saveLocalData();
            }

            showToast('Pedido entregue!', 'success');
            renderKitchenOrders();
        }

        // Toggle Item Status (for individual items in kitchen)
        function toggleItemStatus(orderId, itemId) {
            const order = orders[orderId];
            const item = order.items.find(i => i.id === itemId);
            
            if (item) {
                item.completed = !item.completed;
                
                if (db) {
                    db.ref(`orders/${orderId}`).set(order);
                } else {
                    saveLocalData();
                }
                
                renderKitchenOrders();
            }
        }

        // Update Stats
        function updateStats() {
            const occupiedTables = Object.values(tables).filter(t => t.status !== 'empty').length;
            const pendingOrders = Object.values(orders).filter(o => o.status !== 'completed').length;
            
            const occupiedEl = document.getElementById('occupiedCount');
            const pendingEl = document.getElementById('pendingCount');
            
            if (occupiedEl) occupiedEl.textContent = occupiedTables;
            if (pendingEl) pendingEl.textContent = pendingOrders;
        }

        // Update Kitchen Stats
        function updateKitchenStats() {
            const activeOrders = Object.values(orders).filter(o => o.status !== 'completed').length;
            const activeEl = document.getElementById('activeOrdersCount');
            
            if (activeEl) activeEl.textContent = activeOrders;
        }

        // Category Button Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Category buttons
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    renderMenuItems(this.dataset.category);
                });
            });

            // Close modal when clicking outside
            document.getElementById('orderModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            // Initialize app
            init();
        });

        // Show Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Clear Table (Admin function)
        function clearTable(tableNumber) {
            if (confirm(`Deseja limpar a Mesa ${tableNumber}?`)) {
                // Remove all orders from this table
                Object.keys(orders).forEach(orderId => {
                    if (orders[orderId].tableNumber === tableNumber) {
                        delete orders[orderId];
                    }
                });

                // Reset table
                tables[tableNumber] = {
                    number: tableNumber,
                    status: 'empty',
                    orders: [],
                    total: 0
                };

                if (db) {
                    db.ref(`tables/${tableNumber}`).set(tables[tableNumber]);
                    // Remove orders from Firebase
                    Object.keys(orders).forEach(orderId => {
                        if (orders[orderId].tableNumber === tableNumber) {
                            db.ref(`orders/${orderId}`).remove();
                        }
                    });
                } else {
                    saveLocalData();
                }

                showToast(`Mesa ${tableNumber} limpa!`, 'success');
                renderTables();
            }
        }

        // Process Payment
        function processPayment(tableNumber) {
            if (confirm(`Confirmar pagamento da Mesa ${tableNumber}?`)) {
                // Mark all orders as completed
                Object.keys(orders).forEach(orderId => {
                    if (orders[orderId].tableNumber === tableNumber) {
                        orders[orderId].status = 'completed';
                        orders[orderId].paidAt = new Date().toISOString();
                    }
                });

                // Reset table
                tables[tableNumber] = {
                    number: tableNumber,
                    status: 'empty',
                    orders: [],
                    total: 0
                };

                if (db) {
                    db.ref(`tables/${tableNumber}`).set(tables[tableNumber]);
                    Object.keys(orders).forEach(orderId => {
                        if (orders[orderId].tableNumber === tableNumber) {
                            db.ref(`orders/${orderId}`).set(orders[orderId]);
                        }
                    });
                } else {
                    saveLocalData();
                }

                showToast(`Pagamento da Mesa ${tableNumber} processado!`, 'success');
                renderTables();
            }
        }

        // Add right-click context menu for tables (admin functions)
        function addContextMenu() {
            document.addEventListener('contextmenu', function(e) {
                const tableCard = e.target.closest('.table-card');
                if (tableCard) {
                    e.preventDefault();
                    
                    const tableNumber = parseInt(tableCard.querySelector('.table-number').textContent.replace('Mesa ', ''));
                    const table = tables[tableNumber];
                    
                    let contextMenu = document.getElementById('contextMenu');
                    if (!contextMenu) {
                        contextMenu = document.createElement('div');
                        contextMenu.id = 'contextMenu';
                        contextMenu.style.cssText = `
                            position: fixed;
                            background: white;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            padding: 8px 0;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                            z-index: 1000;
                            min-width: 150px;
                        `;
                        document.body.appendChild(contextMenu);
                    }
                    
                    contextMenu.innerHTML = `
                        <div style="padding: 8px 16px; cursor: pointer; hover:background: #f5f5f5;" onclick="clearTable(${tableNumber}); hideContextMenu();">Limpar Mesa</div>
                        ${table.status === 'waiting-payment' ? 
                            `<div style="padding: 8px 16px; cursor: pointer; color: #28a745;" onclick="processPayment(${tableNumber}); hideContextMenu();">Processar Pagamento</div>` : ''}
                    `;
                    
                    contextMenu.style.left = e.pageX + 'px';
                    contextMenu.style.top = e.pageY + 'px';
                    contextMenu.style.display = 'block';
                }
            });

            document.addEventListener('click', hideContextMenu);
        }

        function hideContextMenu() {
            const contextMenu = document.getElementById('contextMenu');
            if (contextMenu) {
                contextMenu.style.display = 'none';
            }
        }

        // Auto-refresh for real-time updates
        function startAutoRefresh() {
            setInterval(() => {
                if (currentView === 'cashier') {
                    updateStats();
                } else if (currentView === 'kitchen') {
                    updateKitchenStats();
                }
            }, 10000); // Update every 10 seconds
        }

        // Initialize auto-refresh and context menu when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            addContextMenu();
            startAutoRefresh();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // ESC to close modal
            if (e.key === 'Escape' && document.getElementById('orderModal').classList.contains('active')) {
                closeModal();
            }
            
            // F5 to refresh data
            if (e.key === 'F5') {
                e.preventDefault();
                location.reload();
            }
        });

        // Service Worker for offline functionality (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful');
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // Export data function (for backup)
        function exportData() {
            const data = {
                tables: tables,
                orders: orders,
                exported: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `restaurant-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Dados exportados com sucesso!', 'success');
        }

        // Debug function (console only)
        window.debugRestaurant = {
            tables,
            orders,
            currentOrder,
            currentTable,
            exportData,
            clearAllTables: () => {
                if (confirm('ATENÇÃO: Isso irá limpar todas as mesas e pedidos. Confirma?')) {
                    Object.keys(tables).forEach(tableNum => {
                        tables[tableNum] = {
                            number: parseInt(tableNum),
                            status: 'empty',
                            orders: [],
                            total: 0
                        };
                    });
                    
                    if (db) {
                        db.ref('tables').set(tables);
                        db.ref('orders').set({});
                    } else {
                        localStorage.clear();
                    }
                    
                    location.reload();
                }
            }
        };
    </script>
</body>
</html>
